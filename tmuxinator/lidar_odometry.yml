<%
# Parameters - configurable via environment variables
foxglove = ENV['FOXGLOVE'] || 'false'
rviz = ENV['RVIZ'] || 'true'
topic = ENV['TOPIC'] || '/livox/points'
publish_freq = ENV['PUBLISH_FREQ'] || '10.0'
frame_id = ENV['FRAME_ID'] || 'livox_frame'
use_sim_time = ENV['USE_SIM_TIME'] || 'false'
config_file = ENV['CONFIG_FILE'] || 'config.yaml'

# Project root
project_root = ENV['PWD'] || File.expand_path('.')
%>
name: lidar_odometry
root: <%= project_root %>
startup_window: monitoring

# Pre-window commands (runs once before creating windows)
pre_window: |
  export ROS_DOMAIN_ID=0
  echo "================================================"
  echo "  LiDAR Odometry System"
  echo "================================================"
  echo "Configuration:"
  echo "  Topic:        <%= topic %>"
  echo "  Publish Freq: <%= publish_freq %> Hz"
  echo "  Frame ID:     <%= frame_id %>"
  echo "  Foxglove:     <%= foxglove %>"
  echo "  RViz:         <%= rviz %>"
  echo "  Sim Time:     <%= use_sim_time %>"
  echo "  Config:       <%= config_file %>"
  echo "================================================"
  echo ""

windows:
  - sensors:
      layout: main-horizontal
      panes:
        - livox_driver:
            - echo "üöÄ Starting Livox LiDAR Driver..."
            - pixi run ros2 launch lidarodom livox.launch.py
              foxglove:=<%= foxglove %>
              rviz:=<%= rviz %>
              publish_freq:=<%= publish_freq %>
              frame_id:=<%= frame_id %>

  - odometry:
      layout: main-horizontal
      panes:
        - kiss_icp:
            - echo "‚è≥ Waiting for LiDAR driver to initialize..."
            - sleep 7
            - echo "üöÄ Starting KISS-ICP Odometry..."
            - pixi run ros2 launch lidarodom odometry.launch.py
              topic:=<%= topic %>
              use_sim_time:=<%= use_sim_time %>
              visualize:=true
              config_file:=<%= config_file %>

  - monitoring:
      layout: tiled
      panes:
          - shell:
            - echo "üíª Free shell for commands"
            - echo ""
            - echo "Useful commands:"
            - echo "  ros2 topic list"
            - echo "  ros2 node list"
            - echo "  ros2 topic echo /kiss/path"
            - echo "  ros2 topic hz <%= topic %>"
